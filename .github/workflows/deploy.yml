name: ğŸš€ Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ³ Desplegar aplicaciÃ³n
      uses: appleboy/ssh-action@v0.1.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
script: |
        echo "ğŸ”§ Iniciando despliegue automÃ¡tico..."
        cd /opt/smartlend/smartlend
        
        echo "ğŸ”„ Actualizando cÃ³digo desde GitHub..."
        git fetch origin
        git reset --hard origin/main
        
        echo "ğŸ“¦ Instalando dependencias y construyendo la aplicaciÃ³n..."
        npm install
        rm -rf dist
        npm run build
        
        echo "ğŸ³ Construyendo nueva imagen Docker (sin cachÃ©)..."
        docker build --no-cache -t smartlend:latest .
        
        echo "ğŸ›‘ Deteniendo y eliminando contenedor anterior..."
        docker stop smartlend-app || true
        docker rm smartlend-app || true
        
        echo "ğŸ§¹ Limpiando imÃ¡genes Docker antiguas (dangling)..."
        docker image prune -f  # <--- ESTA ES LA FORMA CORRECTA (reemplaza tu 'docker rmi ...')
        
        echo "ğŸš€ Iniciando nuevo contenedor..."
        docker run -d -p 8080:80 --name smartlend-app smartlend:latest
        
        echo "â³ Esperando que la aplicaciÃ³n inicie (10s)..."
        sleep 10
        
        echo "ğŸ“Š Verificando estado del contenedor:"
        docker ps
        
        echo "ğŸ” Â¡CAZANDO EL CAMBIO! Buscando 'TEST 2' dentro del contenedor..."
        # Esta lÃ­nea buscarÃ¡ "TEST 2" en el HTML que sirve el contenedor.
        # Si no lo encuentra, el workflow fallarÃ¡ (lo cual es bueno).
        curl -s http://localhost:8080 | grep "TEST 2"
        
        echo "ğŸ‰ Despliegue completado exitosamente!"
